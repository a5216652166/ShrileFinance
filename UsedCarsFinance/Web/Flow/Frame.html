<!DOCTYPE html>
<html>
<head>
    <title>框架</title>
    <meta charset="utf-8" />
    <link href="../Content/easyui/themes/gray/easyui.css" rel="stylesheet" />
    <link href="../Content/easyui/themes/icon.css" rel="stylesheet" />
    <script src="../Scripts/jquery/jquery.js"></script>
    <script src="../Scripts/easyui/jquery.easyui.js"></script>
    <script src="../Scripts/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="../Scripts/usedcars.js"></script>
    <style>
        #opinion, #buttons { text-align: center; margin: 7px auto; }
        #buttons .l-btn { width: 80px; margin: 0 15px; }
        #buttons .l-btn .l-btn-text { line-height: 30px; }
    </style>
    <script>
        var flow = {
            InstanceId: "",
            Forms: []
        };

        $(function () {
            flow.InstanceId = uc.GetParams().instanceId;

            if (flow.InstanceId) {
                LoadFrame(flow.InstanceId);
            }
        });

        function LoadFrame(instanceId) {
            $.ajax({
                async: true,
                data: { instanceId: instanceId },
                method: "GET",
                url: "../api/Instance/GetFrame",
                statusCode: {
                    200: function (data) {
                        RanderTabs(data.Forms);
                        RanderButtons(data.Actions);

                        if (data.HasInnerOpinion) {
                            $("#InOpinion").parent().show();
                        }
                    }
                }
            });
        }

        function RanderTabs(forms) {
            var openIndex;

            $(forms).each(function (i, form) {
                var link = form.Link;

                link += "?state=" + form.State;

                if (form.IsHandler) {
                    flow.Forms.push(form);
                }

                if (openIndex == undefined && form.IsOpen) {
                    openIndex = i;
                }

                $("#tabs").tabs("add", {
                    id: form.Id,
                    title: form.Name
                }).tabs("getTab", i).data("url", link);
            });

            if (forms.length > 0) {
                $("#tabs").tabs("select", openIndex || 0);
            }
        }

        function TabSelect(title, index) {
            var tab = $("#tabs").tabs("getSelected");

            var url = tab.data("url");

            if (url) {
                $("#tabs").tabs("update", {
                    tab: tab,
                    options: {
                        content: "<iframe name='" + tab.attr("id") + "' scrolling='auto' frameborder='0'  src='" + url + "' style='width:100%;height:99%;'></iframe>"
                    }
                });

                tab.removeData("url");
            }
        }

        function RanderButtons(actions) {
            // TODO: 模拟测试, click 事件使用 Transfer 方法
            $(actions).each(function (i, action) {
                $("<a>").linkbutton({
                    id: "action_" + action.Id,
                    text: action.Name,
                    plain: false,
                    onClick: Transfer
                    // onClick: action.Method ? TransferWithData : Transfer
                }).appendTo("#buttons");
            });
        }

        function Transfer(data) {
            $("#buttons .l-btn").not(":first").linkbutton("disable");

            var dataPosted = {
                InstanceId: flow.InstanceId,
                ActionId: this.id.substr(7),
                InOpinion: $("#InOpinion").textbox("getValue"),
                ExOpinion: $("#ExOpinion").textbox("getValue"),
                Data: data
            };

            $.ajax({
                async: true,
                data: dataPosted,
                method: "POST",
                url: "../api/Instance/Transfer",
                statusCode: {
                    200: function (data) {
                        $.messager.show({ msg: "执行流程成功！" });

                        uc.CloseWindow();
                    },
                    400: uc.E400
                },
                error: function () {
                    $("#buttons .l-btn").not(":first").linkbutton("enable");
                }
            });
        }

        function TransferWithData() {
            var isValid = true;

            $(flow.Forms).each(function (i, form) {
                var frame = frames[form.Id];

                if (frame) {
                    isValid &= frame.ValidData();

                    if (!isValid) {
                        $.messager.show({ msg: form.Name + "验证未通过." });
                    }
                } else {
                    $.messager.show({ msg: form.Name + "尚未处理." });
                }
            });

            if (isValid) {
                var data = {};

                $(flow.Forms).each(function (i, form) {
                    var frame = frames[form.Id];

                    data[form.Id] = JSON.stringify(frame.BuildData());
                });

                Transfer(data);
            }
        }
    </script>
</head>

<body class="easyui-layout" data-options="fit:true">
    <div data-options="region:'center'">
        <div id="tabs" class="easyui-tabs" data-options="fit:true,onSelect:TabSelect"></div>
    </div>

    <div data-options="region:'south',height:120">
        <div id="opinion">
            <div style="padding-left:24px;">
                <label for="ExOpinion">意见:</label>
                <input id="ExOpinion" name="ExOpinion" class="easyui-textbox" data-options="width:600,height:32" />
            </div>

            <div style="display:none;">
                <label for="InOpinion">内部意见:</label>
                <input id="InOpinion" name="InOpinion" class="easyui-textbox" data-options="width:600,height:32" />
            </div>
        </div>
        <div id="buttons">
            <a id="saveTempData" class="easyui-linkbutton">存至草稿</a>
        </div>
    </div>
</body>
</html>

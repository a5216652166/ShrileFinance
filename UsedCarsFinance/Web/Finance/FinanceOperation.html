<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>运营</title>
    <meta charset="utf-8" />
    <link href="../Content/easyui/themes/bootstrap/easyui.css" rel="stylesheet" />
    <link href="../Content/easyui/themes/icon.css" rel="stylesheet" />
    <link href="../Content/form-bootstrap.css" rel="stylesheet" />
    <script src="../Scripts/jquery/jquery.js"></script>
    <script src="../Scripts/easyui/jquery.easyui.js"></script>
    <script src="../Scripts/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="Content/FinanceJs.js"></script>
    <script src="../Scripts/usedcars.js"></script>
    <script src="../BankInfo/JS/validType.js"></script>
    <style>
        td > .textbox[style*="height: 22px;"] {
            height: 22px !important;
        }

            td > .textbox[style*="height: 22px;"] > .textbox-text {
                padding: 0px 4px !important;
                font-size: 12px !important;
                line-height: 1.42857143;
            }
    </style>

    <script type="text/javascript">
        var query = {};

        $(function () {
            // 获取参数
            query.state = GetQueryString("state");
            query.FinanceId = parent.flow.RootKey;
            // 初始化
            Init(query);
        });

        // LoadData方法
        function LoadData(data) {
            if (data) {
                if (data.LoanPrincipal) {
                    $('fieldset[name=CreditBankInfo] select[comboname=LoanPrincipal]').combobox('unselect', data.LoanPrincipal).combobox('select', data.LoanPrincipal);
                }

                // 加载运营基础信息(租赁信息)
                LoadDataBase(data);

                // 加载融资项
                $("fieldset#financeItem table#financeItem_dg").datagrid("loadData", data.FinancialItem);

                if (query.state == 0) {
                    // 显示车辆信息
                    if ($("form fieldset[name=VehicleInfo]")[0] == undefined) {
                        $($("form template#VehicleInfo").html()).insertAfter($("form fieldset[name=Operation]"));
                        $.parser.parse($("form fieldset[name=VehicleInfo]"));
                    }
                    FieldsetLoadDateFactory("VehicleInfo", "text", data);


                    // 禁用所有
                    Disabled($("fieldset"));

                    // 禁用合同
                    ContactCheck = false;
                    $('fieldset[name=Contact] div[id=Contact_tb]').hide();
                    Disabled($('fieldset[name=Contact]'));

                    $("#account_tb").hide();
                    $("#account_tbl").hide();
                }
                else if (query.state == 1) {
                    // 运营
                    LoadData_Opera(data);

                    if ($('#Contact_dg').datagrid('getSelections').length == 0) {
                        // 合同全选
                        $('#Contact_dg').datagrid('selectAll')
                    }
                    $("#account_tb").hide();
                    $("#account_tbl").hide();
                }
                else if (query.state == 2) {
                    // 客户
                    LoadData_Cust(data);                    
                }

                // 加载放款信息
                if (data.CreditAccountName) {
                    $("table#account_dg").datagrid("loadData", JSON.parse(data.CreditAccountName));
                }
                // 加载还款信息
                if (data.CustomerAccountName) {
                    $("table#account_dgl").datagrid("loadData", JSON.parse(data.CustomerAccountName));
                }
            }
        }

        //验证数据
        function ValidData() {
            var valid = $("form[name=FinanceOperation]").form("validate");
            if ($("#account_dgl").datagrid("getData").total < 1 || $("#account_dg").datagrid("getData").total < 1)
            {
                if (query.state == 2)
                {
                   valid = false;
                }
            }

            return valid;
        }

        //构建数据
        function BuildData() {
            var value = {};
            // 记录节点类型
            value.NodeType = $('form[name=FinanceOperation]>input[name=NodeType]').val();

            // 序列化放款信息
            value.CreditAccountName = JSON.stringify($("table#account_dg").datagrid("getRows"));
            ////TraverseDateFactory(FieldsetSerializeFactory("CreditBankInfo", "text"), value, false, null);

            //if (value.NodeType == "Customer") {
            // 记录融资标识
            value.FinanceId = $('fieldset[name=Operation]>input[name=FinanceId]').val();

            // 序列化还款信息
            //TraverseDateFactory(FieldsetSerializeFactory("CustomerBankInfo", "text"), value, false, null);
            value.CustomerAccountName = JSON.stringify($("table#account_dgl").datagrid("getRows"));

            // 序列化车辆信息
            TraverseDateFactory(FieldsetSerializeFactory("VehicleInfo", "text"), value, false, null);

            // 序列化租赁信息
            TraverseDateFactory(FieldsetSerializeFactory('Operation', 'text'), value, false, null);

            // 序列化合同信息
            var array = [];
            var rows = $('#Contact_dg').datagrid('getRows');
            if (rows.length > 0) {
                if ($.inArray(rows[0], $('#Contact_dg').datagrid('getSelections')) == -1) {
                    array.push(rows[0]);
                }

                $($('#Contact_dg').datagrid('getSelections')).each(function (i, e) {
                    if (e.Name.length > 0) {
                        array.push(e);
                    }
                });
            }
            value.ContactJson = JSON.stringify(array);
            return value;
        }
    </script>

    <script type="text/javascript">
        // 初始化
        function Init(query) {
            // 显示运营页面
            $('form[name=FinanceOperation]').append($('form[name=FinanceOperation] template#Operation').html());
            $.parser.parse($('form[name=FinanceOperation]'));

            // 加载远程数据
            if (query == undefined || query.FinanceId == undefined) {
                return;
            }

            // 加载运营
            $.ajax({
                async: false,
                method: "GET",
                data: { financeId: query.FinanceId },
                url: '../api/Operation/GetOperation',
                statusCode: {
                    200: function (data) {
                        LoadData(data);
                    }
                }
            });
        }

        // 运营基础信息加载
        function LoadDataBase(data) {
            if (data) {
                // 加载放还款信息
                FieldsetLoadDateFactory('CreditBankInfo', 'text', data);
                FieldsetLoadDateFactory('CustomerBankInfo', 'text', data);

                FieldsetLoadDateFactory('Operation', 'text', data);

                // 加载合同
                if (data.ContactJson) {
                    FieldsetLoadDateFactory('Contact', 'table', JSON.parse(data.ContactJson));
                }
                else {
                    var contactTempData = [
                        { Name: "融资租赁合同" }, { Name: "保证合同" }, { Name: "车辆抵押合同" },
                        { Name: "客户确认表" }, { Name: "建行授权书" }, { Name: "分期放款表" },
                        { Name: "车辆交接声明" }, { Name: "扣款委托书" }, { Name: "未婚声明书" },
                        { Name: "车辆处置声明书" }, { Name: "付款指示函" }, { Name: "收据" },
                        { Name: "合格证照片" }, { Name: "车辆销售合同" }, { Name: "车辆照片" }
                    ];

                    FieldsetLoadDateFactory('Contact', 'table', contactTempData);
                }

                $('fieldset[name=Contact] table#Contact_dg').prev().children().eq(1).find("tr input[type=checkbox]").eq(0).hide()
            }
        }

        // 运营
        function LoadData_Opera(data) {
            // 记录节点类型
            $('form[name=FinanceOperation]>input[name=NodeType]').val("Channel");

            // 禁用还款信息
            Disabled($('fieldset[name=CustomerBankInfo]'));
        }

        // 客户
        function LoadData_Cust(data) {
            // 记录节点类型
            $('form[name=FinanceOperation]>input[name=NodeType]').val("Customer");

            ////if (data.LoanPrincipal != "Customer") {
            ////    // 禁用放款信息
            ////    Disabled($('fieldset[name=CreditBankInfo]'));
            ////}
            ////else {
            ////    $("fieldset[name=CreditBankInfo] select[comboname=LoanPrincipal]").combobox('disable');
            ////}

            // 加载放款信息
            FieldsetLoadDateFactory("CreditBankInfo", 'text', data);

            // 加载还款信息
            $("fieldset[name=CustomerBankInfo]>div.row>div.col-6").remove();
            $("fieldset[name=CustomerBankInfo]>div.row").append($("fieldset[name=CustomerBankInfo]>div.row>template#CustomerBankInfo").html());
            $.parser.parse($("fieldset[name=CustomerBankInfo]>div.row"));
            FieldsetLoadDateFactory("CustomerBankInfo", 'text', data);

            // 加载车辆信息
            if ($("form fieldset[name=VehicleInfo]")[0] == undefined) {
                $($("form template#VehicleInfo").html()).insertAfter($("form fieldset[name=Operation]"));
                $.parser.parse($("form fieldset[name=VehicleInfo]"));
            }
            FieldsetLoadDateFactory("VehicleInfo", "text", data);

            // 禁用租赁信息
            Disabled($('fieldset[name=Operation]'));

            // 禁用合同
            ContactCheck = false;
            $('fieldset[name=Contact] div[id=Contact_tb]').hide();
            Disabled($('fieldset[name=Contact]'));
        }
    </script>
</head>
<body>
    <form name="FinanceOperation" class="container">
        <input type="hidden" name="NodeType" value="Operation" placeholder="节点类型（运营/客户）" />

        <template id="Operation">

            <fieldset name="CreditBankInfo">
                <legend>放款信息</legend>
                <table id="account_dg" class="easyui-datagrid" data-options="singleSelect: true,
                            toolbar: '#account_tb', onClickCell: onClickCell, onEndEdit: onEndEdit">
                    <thead>
                        <tr>
                            <th data-options="field:'CreditAccountName',width:200,
                                        editor:{
                                            type:'textbox',
                                            options:{
                                                required:true,
                                                readonly:false,
                                                validType:'',
                                                delay:800
                                               }
                                    }">放款账户</th>
                            <th data-options="field:'CreditBankName',width:200,
                                    editor:{
                                        type:'textbox',
                                        options:{
                                            required:true
                                        }
                                    }">开户行</th>
                            <th data-options="field:'CreditBankCard',width:200,
                                        editor:{
                                            type:'textbox',
                                            options:{
                                                required:true,
                                                validType:['Integer','length[19,19]']
                                            }
                                        }">卡号</th>
                            <th data-options="field:'CreditMoney',width:100,
                                        editor:{
                                            type:'textbox',
                                            options:{
                                                required:true,
                                                validType:'Money'
                                            }
                                        }">金额</th>
                        </tr>
                    </thead>
                </table>
                <div id="account_tb">
                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true,onClick:AppendAccount">添加</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true,onClick:RemoveAccount">移除</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true,onClick:AcceptAccount">确定</a>
                </div>
                <script>
                    var editIndex = undefined;
                    function endEditing() {
                        if (editIndex == undefined) { return true; }
                        if ($("#account_dg").datagrid("validateRow", editIndex)) {
                            $("#account_dg").datagrid("endEdit", editIndex);
                            editIndex = undefined;
                            return true;
                        } else {
                            return false;
                        }
                    }
                    function onClickCell(index, field) {
                        if (editIndex != index) {
                            if (endEditing()) {
                                $("#account_dg").datagrid("selectRow", index)
                                    .datagrid("beginEdit", index);
                                var ed = $("#account_dg").datagrid("getEditor", { index: index, field: field });
                                if (ed) {
                                    ($(ed.target).data("textbox") ? $(ed.target).textbox("textbox") : $(ed.target)).focus();
                                }
                                editIndex = index;
                            } else {
                                setTimeout(function () {
                                    $("#account_dg").datagrid("selectRow", editIndex);
                                }, 0);
                            }
                        }
                    }
                    function onEndEdit(index, row) {
                        //var ed = $(this).datagrid('getEditor', {
                        //    index: index,
                        //    field: 'Role'
                        //});
                        //row.RoleName = $(ed.target).combobox('getText');
                    }
                    function AppendAccount() {
                        if (endEditing()) {
                            $("#account_dg").datagrid("appendRow", { Role: "客户" });
                            editIndex = $("#account_dg").datagrid("getRows").length - 1;

                            $("#account_dg").datagrid("selectRow", editIndex)
                                .datagrid("beginEdit", editIndex);

                            var ed = $("#account_dg").datagrid('getEditor', {
                                index: editIndex,
                                field: 'Username'
                            });
                            $(ed.target).textbox("readonly", false).textbox("enableValidation");
                        }
                    }
                    function RemoveAccount() {
                        if (editIndex == undefined) { return; }
                        $("#account_dg").datagrid("cancelEdit", editIndex)
                            .datagrid("deleteRow", editIndex);
                        editIndex = undefined;
                    }
                    function AcceptAccount() {
                        if (endEditing()) {
                            $("#account_dg").datagrid("acceptChanges");
                        }
                    }
                </script>
            </fieldset>

            <fieldset name="CustomerBankInfo">
                <legend>还款信息</legend>
                <table id="account_dgl" class="easyui-datagrid" data-options="singleSelect: true,
                            toolbar: '#account_tbl', onClickCell: onClickCell, onEndEdit: onEndEdit">
                    <thead>
                        <tr>
                            <th data-options="field:'CustomerAccountName',width:200,
                                        editor:{
                                            type:'textbox',
                                            options:{
                                                required:true,
                                                readonly:false,
                                                validType:'',
                                                delay:800
                                               }
                                    }">还款账户</th>
                            <th data-options="field:'CustomerBankName',width:200,
                                    editor:{
                                        type:'textbox',
                                        options:{
                                            required:true
                                        }
                                    }">开户行</th>
                            <th data-options="field:'CustomerBankCard',width:200,
                                        editor:{
                                            type:'textbox',
                                            options:{
                                                required:true,
                                                validType:['Integer','length[19,19]']
                                            }
                                        }">卡号</th>
                        </tr>
                    </thead>
                </table>
                <div id="account_tbl">
                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true,onClick:AppendAccount1">添加</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true,onClick:RemoveAccount1">移除</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true,onClick:AcceptAccount1">确定</a>
                </div>
                <script>
                    var editIndex1 = undefined;
                    function endEditing1() {
                        if (editIndex1 == undefined) { return true; }
                        if ($("#account_dgl").datagrid("validateRow", editIndex1)) {
                            $("#account_dgl").datagrid("endEdit", editIndex1);
                            editIndex1 = undefined;
                            return true;
                        } else {
                            return false;
                        }
                    }
                    function onClickCell1(index, field) {
                        if (editIndex1 != index) {
                            if (endEditing1()) {
                                $("#account_dgl").datagrid("selectRow", index)
                                    .datagrid("beginEdit", index);
                                var ed = $("#account_dgl").datagrid("getEditor", { index: index, field: field });
                                if (ed) {
                                    ($(ed.target).data("textbox") ? $(ed.target).textbox("textbox") : $(ed.target)).focus();
                                }
                                editIndex1 = index;
                            } else {
                                setTimeout(function () {
                                    $("#account_dgl").datagrid("selectRow", editIndex1);
                                }, 0);
                            }
                        }
                    }
                    function onEndEdit1(index, row) {
                        //var ed = $(this).datagrid('getEditor', {
                        //    index: index,
                        //    field: 'Role'
                        //});
                        //row.RoleName = $(ed.target).combobox('getText');
                    }
                    function AppendAccount1() {
                        if (endEditing1()) {
                            $("#account_dgl").datagrid("appendRow", { Role: "客户" });
                            editIndex1 = $("#account_dgl").datagrid("getRows").length - 1;

                            $("#account_dgl").datagrid("selectRow", editIndex1)
                                .datagrid("beginEdit", editIndex1);

                            var ed = $("#account_dgl").datagrid('getEditor', {
                                index: editIndex1,
                                field: 'Username'
                            });
                            $(ed.target).textbox("readonly", false).textbox("enableValidation");
                        }
                    }
                    function RemoveAccount1() {
                        if (editIndex1 == undefined) { return; }
                        $("#account_dgl").datagrid("cancelEdit", editIndex1)
                            .datagrid("deleteRow", editIndex1);
                        editIndex1 = undefined;
                    }
                    function AcceptAccount1() {
                        if (endEditing1()) {
                            $("#account_dgl").datagrid("acceptChanges");
                        }
                    }
                </script>
            </fieldset>

            <fieldset name="Operation">
                <legend><!--运营-->租赁信息</legend>
                <input type="hidden" name="FinanceId" value="00000000-0000-0000-0000-000000000000" placeholder="融资标识" />
                <input type="hidden" name="CustomerBailRatio" value="0" placeholder="客户保证金比例" />

                <div class="row">

                    <div class="col-6">
                        <label>租赁方式：</label>
                        <select name="LeaseMode" class="easyui-combobox" data-options="required:true,validType:'',value:'',readonly:false,editable:false">
                            <option value="1">直租</option>
                            <option value="2">回租</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label>有无还车条款：</label>
                        <select name="VehicleClause" class="easyui-combobox" data-options="required:true,validType:'',value:'',readonly:false,editable:false">
                            <option value="1">有</option>
                            <option value="2">无</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label>融资租赁合同编号:</label>
                        <input name="LeaseNo" class="easyui-textbox" data-options="validType:'',required:true" />
                    </div>
                    <div class="col-6">
                        <label>车辆抵押合同编号:</label>
                        <input name="VehicleMortgageContractNo" class="easyui-textbox" data-options="validType:'',required:true" />
                    </div>

                    <div class="col-6">
                        <label>保证人名称1:</label>
                        <input name="GuarantorName1" class="easyui-textbox" data-options="validType:'',required:false" />
                    </div>
                    <div class="col-6">
                        <label>保证合同编号1:</label>
                        <input name="GuarantorNo1" class="easyui-textbox" data-options="validType:'',required:false" />
                    </div>

                    <div class="col-6">
                        <label>保证人名称2:</label>
                        <input name="GuarantorName2" class="easyui-textbox" data-options="validType:'',required:false" />
                    </div>
                    <div class="col-6">
                        <label>保证合同编号2:</label>
                        <input name="GuarantorNo2" class="easyui-textbox" data-options="validType:'',required:false" />
                    </div>

                    <div class="col-6">
                        <label>选择还款日：</label>
                        <select name="RepaymentDate" class="easyui-combobox" data-options="required:true,validType:'',value:'',readonly:false,editable:false">
                            <option value="10">每月10号</option>
                            <option value="25">每月25号</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label>首次租金支付日期：</label>
                        <input name="RepayRentDate" class="easyui-datebox" data-options="required:true,validType:'',readonly:false,editable:false,width:410" />
                    </div>

                    <div class="col-6">
                        <label>客户应付租金起始日期：</label>
                        <input name="RentPayableStartDate" class="easyui-datebox" data-options="required:true,validType:'',readonly:false,editable:false,width:410" />
                    </div>
                    <div class="col-6">
                        <label>车辆抵押要求:</label>
                        <select name="MortgageRequirements" class="easyui-combobox" data-options="required:true,validType:'',value:'',readonly:false,editable:false">
                            <option value="1">无</option>
                            <option value="2">抵押晟融</option>
                            <option value="3">抵押东海银行</option>
                            <!--<option value="4">其他公司</option>-->
                        </select>
                    </div>
                </div>
            </fieldset>

            <template id="VehicleInfo">
                <fieldset name="VehicleInfo">
                    <legend style="margin-top:25px;">车辆补充信息</legend>
                    <div class="row">
                        <div class="col-6">
                            <label>车牌号:</label>
                            <input name="PlateNo" class="easyui-textbox" data-options="validType:['PlateNo'],required:false" />
                        </div>

                        <div class="col-6">
                            <label>车架号:</label>
                            <input name="FrameNo" class="easyui-textbox" data-options="validType:['AN','length[17,17]'],required:true" />
                        </div>

                        <div class="col-6">
                            <label>发动机号:</label>
                            <input name="EngineNo" class="easyui-textbox" data-options="validType:['AN','length[0,20]'],required:false" />
                        </div>

                        <div class="col-6">
                            <label>注册登记日期:</label>
                            <input name="RegisterDate" class="easyui-textbox" data-options="validType:['YearMonth'],required:false" />
                        </div>

                        <div class="col-6">
                            <label>行驶里程:</label>
                            <input name="RunningMiles" class="easyui-textbox" data-options="validType:['Integer','length[0,9]'],required:false" />
                            <span class="unit">公里</span>
                        </div>

                        <div class="col-6">
                            <label>车辆出厂日期:</label>
                            <input name="FactoryDate" class="easyui-datebox" data-options="validType:'Date',required:false,editable:false,width:410" />
                        </div>

                        <div class="col-6">
                            <label>业务类型:</label>
                            <select name="BusinessType" class="easyui-combobox" data-options="editable:false,required:false,value:''">
                                <option value="1">以租代购</option>
                                <option value="2">快速贷</option>
                                <option value="3">押车贷</option>
                                <option value="4">车抵贷</option>
                                <option value="5">二手车交易贷</option>
                                <option value="0">新车交易贷</option>
                            </select>
                        </div>

                        <div class="col-6">
                            <label>车辆上牌城市:</label>
                            <input name="RegisterCity" class="easyui-textbox" data-options="validType:[],required:true" />
                        </div>

                        <div class="col-6">
                            <label>车况:</label>
                            <input name="Condition" type="radio" checked value="0"><span onclick="$(this).prev().click()">新车</span>
                            <input name="Condition" type="radio" value="1"><span onclick="$(this).prev().click()">二手车</span>
                        </div>
                    </div>
                </fieldset>
            </template>

            <fieldset id="financeItem">
                <legend>融资项</legend>
                <table id="financeItem_dg" class="easyui-datagrid" data-options="singleSelect: true, rownumbers: true ">
                    <thead>
                        <tr>
                            <th data-options="field:'Id',hidden:true"></th>
                            <th data-options="field:'Name',width:400,align:'center',
                        editor:{
                            type:'combobox',
                            options:{
                                required:true,
                                validType:'',
                                valueField:'text',
                                textField:'text',
                                data:[
                                {'text':'车价'},
                                {'text':'购置税'},
                                {'text':'车船税'},
                                {'text':'GPS费用'}
                                ]
                            }
                        }">项目名称</th>
                            <th data-options="field:'Principal',width:400,align:'center',
                        editor:{
                            type:'textbox',
                            options:{
                                required:false,
                                validType:''
                            }
                        }">融资本金（元）</th>
                        </tr>
                    </thead>
                </table>
            </fieldset>

            <fieldset name="Contact">
                <legend>所需合同及文件资料</legend>
                <table id="Contact_dg" class="easyui-datagrid" style="width:820px;" data-options="
                           rownumbers:true,
                           onSelect:ContactSelect,
                           onUnselect:ContactUnselect,
                           onDblClickCell:ContactDblClickCell,
                           onSelectAll:SelectAll,
                           onUnselectAll:SelectAll,
                           title:'合同列表'
                   ">
                    <thead>
                        <tr>
                            <th data-options="field:'Check',width:20,align:'center',checkbox:true"></th>
                            <th data-options="field:'Name',width:740,align:'center',editor: {type: 'validatebox',options: {required:true}}">合同名称</th>
                        </tr>
                    </thead>
                </table>

                <!--<div id="Contact_tb" style="height:30px;">
                    <a id="Contact_add" class="easyui-linkbutton" href="javascript:void(0)" data-options="onClick:ContactAdd,iconCls:'icon-add',plain:true">添加</a>
                    <a id="Contact_del" class="easyui-linkbutton" href="javascript:void(0)" data-options="onClick:ContactDelete,iconCls:'icon-remove',plain:true,disabled:true">删除</a>
                    <a id="Contact_Save" style="display:none" class="easyui-linkbutton" href="javascript:void(0)" data-options="onClick:ContactSave,iconCls:'icon-save',plain:true,disabled:true,">保存</a>
                </div>-->
                <script type="text/javascript">
                    // table onSelect事件
                    function ContactSelect(index, row) {
                        if (index == -1 || ContactCheck == false) {
                            $('#Contact_dg').datagrid('uncheckRow', index);
                            return false;
                        }

                        if (row) {
                            if (editRowIndex != index) {
                                ContactSave();
                            }

                            if (index != 0) {
                                $("#Contact_del").linkbutton("enable");
                            }
                        }
                    }
                    var ContactCheck = true;

                    // table 取消选择
                    function ContactUnselect(index, row) {
                        if (row) {
                            if (editRowIndex != index) {
                                ContactSave();
                            }

                            var selectRows = $('#Contact_dg').datagrid('getSelections');
                            if (selectRows.length > 0) {
                                $("#Contact_del").linkbutton("enable");

                                if (selectRows.length == 1) {
                                    if ($('#Contact_dg').datagrid('getRowIndex', selectRows[0]) == 0) {
                                        $("#Contact_del").linkbutton("disable");
                                    }
                                }
                            }
                            else {
                                $("#Contact_del").linkbutton("disable");
                            }
                        }
                    }

                    // table 删除按钮
                    function ContactDelete() {
                        var rows = $('#Contact_dg').datagrid('getSelections');

                        if (rows.length > 0) {
                            $.messager.confirm('确认', '确认删除选中的合同？', function (r) {
                                if (r) {
                                    // 清除所有选择的行
                                    $('#Contact_dg').datagrid('clearSelections', rows);

                                    // 删除选择的行
                                    $(rows).each(function (i, e) {
                                        var rowIndex = $('#Contact_dg').datagrid('getRowIndex', e);

                                        if (rowIndex >= 0) {
                                            // 保存指定行
                                            ContactSave(rowIndex, true);

                                            if ($('#Contact_dg').datagrid('validateRow', rowIndex) && rowIndex != 0) {
                                                $('#Contact_dg').datagrid('deleteRow', rowIndex);
                                            }
                                        }
                                    });

                                    $("#Contact_del").linkbutton("disable");
                                }
                            });
                        }
                    }

                    // table 添加按钮
                    function ContactAdd() {
                        if ($("fieldset[name=Contact]").form("validate")) {
                            $('#Contact_dg').datagrid('appendRow', { Name: '' });

                            // 双击新增行Name单元格
                            var newRow = $('#Contact_dg').datagrid('getRows')

                            // 双击新增行
                            ContactDblClickCell(newRow.length - 1, 'Name', null);
                        }
                    }

                    // 被编辑行索引
                    var editRowIndex = -1;

                    // table 单元格双击
                    function ContactDblClickCell(index, field, value) {
                        // 融资租赁合同不可编辑
                        if (index == 0 || ContactCheck == false) {
                            return;
                        }

                        if (editRowIndex > -1) {
                            ContactSave();
                        }

                        editRowIndex = index;

                        $('fieldset[name=Contact] input[type=checkbox]').attr("disabled", true);

                        // 在双击一个单元格的时候开始编辑并生成编辑器，然后定位到编辑器的输入框上
                        $('#Contact_dg').datagrid('beginEdit', index);
                        var ed = $('#Contact_dg').datagrid('getEditor', { index: index, field: field });

                        $(ed.target).val(ed.oldHtml);

                        $(ed.target).focus();

                        // 启用保存
                        $("#Contact_Save").linkbutton("enable");

                        // Enter事件
                        $('div#Contact_tb').next().find('table input.datagrid-editable-input').keydown(function (event) {
                            if (event.keyCode == 13) {
                                if ($('#Contact_dg').datagrid('validateRow', index)) {
                                    ContactSave(index);
                                }
                            }
                        });
                    }

                    // table 保存单元格的修改
                    function ContactSave(index, flag) {
                        if (index == null) {
                            index = editRowIndex;
                        }

                        if (index == -1) {
                            return false;
                        }

                        var ed = $('#Contact_dg').datagrid('getEditors', index);

                        if (ed.length > 0) {
                            // 重复合同判断
                            var sameflag = false;
                            $($('#Contact_dg').datagrid('getRows')).each(function (i, e) {
                                if (e.Name.length > 0 && i != index && e.Name == ed[0].target.val()) {
                                    sameflag = true;
                                }
                            });
                            if (sameflag) {
                                $.messager.show({ msg: "合同列表已经存在 " + ed[0].target.val() });

                                return;
                            }



                            if (!$('#Contact_dg').datagrid('validateRow', index)) {
                                if (flag == true) {
                                    $(ed[0].target).val('FillData');
                                    $('#Contact_dg').datagrid('endEdit', index);
                                    $('#Contact_dg').datagrid('acceptChanges');
                                    $('#Contact_dg').datagrid('refreshRow', index);
                                }
                                else {
                                    $('#Contact_dg').datagrid('endEdit', index);
                                    $('#Contact_dg').datagrid('acceptChanges');
                                    $('#Contact_dg').datagrid('refreshRow', index);
                                    $('#Contact_dg').datagrid('deleteRow', index);
                                }
                            }
                            else {
                                $('#Contact_dg').datagrid('getRows')[index]['Name'] = $(ed[0].target).val();

                                $('#Contact_dg').datagrid('endEdit', index);

                                $('#Contact_dg').datagrid('acceptChanges');

                                $('#Contact_dg').datagrid('refreshRow', index);

                                editRowIndex = -1;
                            }

                            $('fieldset[name=Contact] input[type=checkbox]').attr("disabled", false);

                            // 禁用保存按钮
                            $("#Contact_Save").linkbutton("disable");

                            return true;
                        }

                        return false;
                    }

                    // table 选择所有
                    function SelectAll() {
                        //$('#Contact_dg').datagrid('uncheckRow', 0)

                        var rows = $('#Contact_dg').datagrid('getSelections');

                        if (rows.length > 0) {
                            $("#Contact_del").linkbutton("enable");
                        }
                        else {
                            $("#Contact_del").linkbutton("disable");
                        }
                    }
                </script>
            </fieldset>
        </template>
    </form>
</body>
</html>

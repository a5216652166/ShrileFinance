<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>产品维护</title>

    <link href="../../Content/easyui/themes/bootstrap/easyui.css" rel="stylesheet" />
    <link href="../../Content/easyui/themes/icon.css" rel="stylesheet" />
    <link href="../../Content/form-bootstrap.css" rel="stylesheet" />
    <script src="../../Scripts/jquery/jquery.js"></script>
    <script src="../../Scripts/easyui/jquery.easyui.js"></script>
    <script src="../../Scripts/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="../../Scripts/usedcars.js"></script>
    <style>
        td > .textbox[style*="height: 22px;"] {
            height: 22px !important;
        }

            td > .textbox[style*="height: 22px;"] > .textbox-text {
                padding: 0px 4px !important;
                font-size: 12px !important;
                line-height: 1.42857143;
            }
    </style>

    <script type="text/javascript">
        var query = uc.GetParams();

        uc.form = new UCForm(".container");

        $(function () {
            Init();
        });

        function Init() {
            if (query.method == "mod" || query.method == "view") {
                $("a#save").linkbutton("disable");

                $.ajax({
                    async: true,
                    type: "Get",
                    data: { produceId: query.ProduceId },
                    url: "../../api/NewProduce/Get",
                    success: function (data) {
                        LoadData(data);
                    }
                });

                $("a#save").linkbutton("enable");

                if (query.method == "mod") {
                    $("form.container fieldset#Base>legend").text("产品编辑");
                    $("#Code").textbox("readonly", true)
                }
                if (query.method == "view") {
                    $("form.container fieldset#Base>legend").text("产品详情");

                    $("#save").linkbutton("disable");

                    Disabled("fieldset")

                    $("form.container fieldset#RepayPrincipals div#RepayPrincipal_tb>a>span").hide();
                }
            }
            else {
                $("form.container fieldset#Base>legend").text("新产品录入");
            }

            // 禁用
            function Disabled(selector) {
                selector = selector || "fieldset";

                $(selector).attr("disabled", "disabled");

                $(selector).find(".easyui-combobox").combobox("disable");


                if ($(selector).hasClass(".easyui-combobox")) {
                    $(selector).combobox("disable");
                }
            }
        }

        function LoadData(data) {
            // 加载基础信息
            $("form.container fieldset#Base").form('load', data);

            // 加载 偿还本金
            var repayPrincipals = [];
            $(data.RepayPrincipal).each(function (i, e) {
                var tempRepay = {};
                tempRepay.YearNum = "第" + (i + 1) + "年";
                tempRepay.PrincipalRate = e;
                tempRepay.MonthCoefficient = 0;

                repayPrincipals.push(tempRepay);
            });
            $("form.container fieldset#RepayPrincipals table#RepayPrincipal_dg").datagrid('loadData', repayPrincipals);
        }

        function BuildData() {
            var data = $("form.container fieldset#Base").serializeJson();

            data.RepayPrincipal = [];

            var repay = $("form.container fieldset#RepayPrincipals table#RepayPrincipal_dg").datagrid("getRows");

            $(repay).each(function (i, e) {
                data.RepayPrincipal.push(parseFloat(e.PrincipalRate));
            });

            return data;
        }

        function ValidData() {
            var valid = $("form.container").form('validate');

            if (valid == false) {
                $.messager.show({ msg: "请填写完必填项！" });

                return valid;
            }

            var data = BuildData();
            data.cal = 0;

            $(data.RepayPrincipal).each(function (i, e) {
                data.cal += parseInt(e * 100);
            });

            valid = valid && (data.cal / 100 == 100);

            if (valid == false) {
                $.messager.show({ msg: "偿还本金比例之和应为100%！" });

                return valid;
            }

            return valid;
        }

        function Submit() {
            if (ValidData() == false) {
                return;
            }

            var url = "../../api/NewProduce/";

            if (query.method == "add") {
                url += "Create";
            }
            else if (query.method == "mod") {
                url += "Modify";
            }

            var data = BuildData();

            $.ajax({
                async: false,
                type: 'POST',
                data: data,
                url: url,
                statusCode: {
                    200: function (data) {
                        uc.form.Cancel();
                        top.$.messager.show({ msg: "提交成功" });
                    },
                    400: function (data) {
                        top.$.messager.show({ msg: data.responseJSON.Message });
                    }
                }
            });
        }
    </script>

    <script type="text/javascript">
        $.extend($.fn.validatebox.defaults.rules, {
            Money: {
                validator: function (value) {
                    if (/^-?\d+\.\d{1}$/.test(value)) {
                        return true;
                    }

                    if (/^-?\d+\.\d{2}$/.test(value) || /^-?\d+$/.test(value)) {
                        if (value.length >= 2 && /^[0][0-9]*$/.test(value.substr(0, 2))) {
                            return false;
                        }

                        return true;
                    }

                    return false;
                },
                message: '请输入整数、一位小数或两位小数！'
            },
            Rate: {
                validator: function (value) {
                    if (isNaN(value) == false) {
                        if (value >= 0 && value <= 100)
                            return true;
                    }

                    return false;
                },
                message: '比例区间[0,100]'
            },
            YearRate: {
                validator: function (value) {
                    if (isNaN(value) == false) {
                        if (value >= 0 && value <= 100)
                            return true;
                    }

                    return false;
                },
                message: '比例区间[0,100],请调整月费率'
            },
            TimeLimit: {
                validator: function (value) {
                    if (isNaN(value) == false) {
                        if (value > 0 && value <= 600)
                            return true;
                    }

                    return false;
                },
                message: '期限区间(0,600]'
            },
            AN: {
                validator: function (value) {
                    return !/[\u4E00-\u9FA5\uF900-\uFA2D]/.test(value);
                },
                message: '只能输入字母或数字或字母数字组合'
            },
            Integer: {// 验证整数
                validator: function (value) {
                    return /^\d+$/.test(value);
                },
                message: '请输入整数'
            }
        });
    </script>
</head>
<body>
    <form class="container">
        <fieldset id="Base">
            <legend>产品信息</legend>

            <div class="hidden">
                <input name="Id" type="hidden" />
            </div>

            <div class="row">
                <div class="col-6">
                    <label>代码:</label>
                    <input name="Code" class="easyui-textbox" data-options="required:true,value:'',validType:['length[0,100]','AN']" />
                </div>

                <div class="col-6">
                    <label>名义利率:</label>
                    <input name="InterestRate" class="easyui-textbox" data-options="required:true,value:'',validType:['Money','length[0,5]','Rate']" />
                    <unit>%</unit>
                </div>

                <div class="col-6">
                    <label>产品类型:</label>
                    <input name="ProduceType" class="easyui-combobox" data-options="required:true,editable:false,
                           valueField: 'value',
		                   textField: 'text',
                           data:[
                           {value:'1',text:'纯分期'},
                           {value:'2',text:'保证金加三期月供提前付'},
                           {value:'3',text:'均匀贷'},
                           {value:'4',text:'低息贷'},
                           {value:'5',text:'保证金加分期'}
                           ]
                    " />
                </div>

                <div class="col-6">
                    <label>租赁方式:</label>
                    <input name="LeaseType" class="easyui-combobox" data-options="required:true,value:'',editable:false,
                           valueField: 'value',
		                   textField: 'text',
                           data:[{value:'1',text:'回租'},{value:'2',text:'直租'}]
                    " />
                </div>

                <div class="col-6">
                    <label>期限:</label>
                    <input name="TimeLimit" class="easyui-textbox" data-options="required:true,value:'',validType:['Integer','TimeLimit'],onChange:ChangeTimeLimit" />
                    <unit>月</unit>
                </div>
                <script type="text/javascript">
                    function ChangeTimeLimit() {
                        var value = $("form.container fieldset#Base input[textboxname=TimeLimit]").textbox('getValue');

                        var interval = $("form.container fieldset#Base input[textboxname=Interval]").textbox('getValue');

                        if (isNaN(value) == false && value != "" && isNaN(interval) == false && interval != "") {
                            // 移除所有行
                            RemoveAllRepayPrincipal();

                            if (interval <= 0 || value <= 0 || value > 600) {
                                return false;
                            }

                            var yearCount = Math.ceil(value / interval / 12);

                            var firstRate = 100;
                            var lastRate = 0;

                            if (yearCount > 1) {
                                lastRate = (100 / yearCount).toFixed(2);

                                if (lastRate > (100 / yearCount)) {
                                    lastRate -= 0.01;
                                }

                                firstRate = 100.00 - lastRate * (yearCount - 1);
                            }

                            var rates = [firstRate.toFixed(2)];

                            for (var i = 0; i < yearCount - 1; i++) {
                                rates.push(lastRate);
                            }

                            // 循环 添加行
                            $(rates).each(function (i, e) {
                                AppendRepayPrincipal(i + 1, e);

                                AcceptRepayPrincipal();
                            });
                        }
                    }
                </script>

                <div class="col-6">
                    <label>间隔:</label>
                    <input name="Interval" class="easyui-textbox" data-options="required:true,value:'1',validType:['Integer','length[0,6]'],onChange:ChangeTimeLimit" />
                    <unit>月</unit>
                </div>

                <div class="col-6">
                    <label>保证金:</label>
                    <input name="MarginRate" class="easyui-textbox" data-options="required:true,value:'',validType:['Money','length[0,5]','Rate']" />
                    <unit>%</unit>
                </div>

                <div class="col-6">
                    <label>手续费:</label>
                    <input name="Poundage" class="easyui-textbox" data-options="required:true,value:'',validType:['Money']" />
                    <unit>元</unit>
                </div>

                <div class="col-6">
                    <label>渠道返点:</label>
                    <input name="ChannelRate" class="easyui-textbox" data-options="required:true,value:'0',validType:['Money','length[0,5]','Rate']" />
                    <unit>%</unit>
                </div>

                <div class="col-6">
                    <label>员工提成:</label>
                    <input name="SalesmanRate" class="easyui-textbox" data-options="required:true,value:'0',validType:['Money','length[0,5]','Rate']" />
                    <unit>%</unit>
                </div>

                <div class="col-6">
                    <label>月费率:</label>
                    <input name="MonthRate" class="easyui-textbox" data-options="required:true,value:'0',validType:['Money','length[0,5]','Rate'],onChange:LoadYearRate" />
                    <unit>%</unit>
                    <script type="text/javascript">
                        function LoadYearRate(value) {
                            var yearRate = 0;

                            if ($("form.container fieldset#Base input[textboxname=MonthRate]").textbox("isValid")) {
                                yearRate = parseInt(value * 100) * 12 / 100;
                            }

                            $("form.container fieldset#Base input#yearRate").textbox("setValue", yearRate);
                        }
                    </script>
                </div>

                <div class="col-6">
                    <label>年费率:</label>
                    <input id="yearRate" class="easyui-textbox" data-options="required:true,value:'0',readonly:true,validType:['Money','length[0,5]','YearRate']" />
                    <unit>%</unit>
                </div>
            </div>


        </fieldset>

        <fieldset id="RepayPrincipals">
            <legend>偿还本金</legend>
            <table id="RepayPrincipal_dg" class="easyui-datagrid" data-options="singleSelect: true,
                   rownumbers: true,
                   toolbar: '#RepayPrincipal_tb',
                   onDblClickRow: onEdit,
                   onEndEdit: onEndEdit,
                   rowStyler: RepayPrincipalStyler
                   ">
                <thead>
                    <tr>
                        <th data-options="field:'Id',hidden:true"></th>
                        <th data-options="field:'YearNum',width:260,align:'center',
                        editor:{
                            type:'textbox',
                            options:{
                                required:true,
                                validType:'',
                                readonly:true
                            }
                        }">年</th>
                        <th data-options="field:'PrincipalRate',width:260,align:'center',
                        editor:{
                            type:'textbox',
                            options:{
                                required:true,
                                validType:'Money'
                            }
                        }">偿还本金比例（%）</th>
                        <th data-options="field:'MonthCoefficient',width:260,align:'center',
                        editor:{
                            type:'textbox',
                            options:{
                                required:true,
                                validType:'Money',
                               editable:true
                            }
                        }">月供系数</th>
                    </tr>
                </thead>
            </table>

            <div id="RepayPrincipal_tb" style="display:none">
                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true,onClick:ModifyRepayPrincipal">修改</a>
                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true,onClick:AcceptRepayPrincipal">确定</a>
            </div>

            <script type="text/javascript">
                        var editIndex = undefined;

                        function endEditing() {
                            if (editIndex == undefined) {
                                return true;
                            }

                            if ($("#RepayPrincipal_dg").datagrid("validateRow", editIndex)) {
                                $("#RepayPrincipal_dg").datagrid("endEdit", editIndex);

                                editIndex = editIndex;

                                return true;
                            }
                            else {
                                top.$.messager.show({ msg: '请填写完正在编辑的融资项' });

                                return false;
                            }
                        }

                        function onEdit(index) {
                            // 禁用状态下，阻止编辑
                            if ($("form.container fieldset#RepayPrincipals").attr("disabled") == "disabled") {
                                return false;
                            }

                            if (endEditing()) {
                                $("#RepayPrincipal_dg").datagrid("beginEdit", index);

                                editIndex = index;
                            }
                            else {
                                setTimeout(function () {
                                    $("#RepayPrincipal_dg").datagrid("selectRow", editIndex);
                                }, 0);
                            }
                        }

                        function onEndEdit(index, row) {
                        }

                        function AppendRepayPrincipal(i, rate) {
                            if (endEditing()) {
                                $("#RepayPrincipal_dg").datagrid("appendRow", {
                                    YearNum: '第' + i + '年',
                                    PrincipalRate: rate,
                                    MonthCoefficient: '0'
                                });

                                editIndex = $("#RepayPrincipal_dg").datagrid("getRows").length - 1;

                                $("#RepayPrincipal_dg").datagrid("selectRow", editIndex)
                                    .datagrid("beginEdit", editIndex);
                            }
                        }

                        function ModifyRepayPrincipal() {
                            var row = $("#RepayPrincipal_dg").datagrid("getSelected");
                            var index = $("#RepayPrincipal_dg").datagrid("getRowIndex", row);

                            if (index >= 0) {
                                onEdit(index);
                            }
                        }

                        function RemoveRepayPrincipal() {
                            var row = $("#RepayPrincipal_dg").datagrid("getSelected");
                            var index = $("#RepayPrincipal_dg").datagrid("getRowIndex", row);

                            $("#RepayPrincipal_dg").datagrid("deleteRow", index);

                            editIndex = undefined;
                        }

                        function AcceptRepayPrincipal() {
                            if (endEditing()) {
                                $("#RepayPrincipal_dg").datagrid("acceptChanges");
                            }
                        }

                        function RepayPrincipalStyler(index, row) {
                        }

                        function RemoveAllRepayPrincipal() {
                            var count = $("#RepayPrincipal_dg").datagrid("getRows").length;

                            for (var i = 0; i < count; i++) {
                                $("#RepayPrincipal_dg").datagrid("deleteRow", 0);
                            }
                        }
            </script>
        </fieldset>

        <div id="btn">
            <a id="save" class="easyui-linkbutton" href="javascript:void(0)" data-options="iconCls:'icon-save',onClick:Submit">保存</a>
            <a id="back" class="easyui-linkbutton" href="javascript:void(0)" data-options="iconCls:'icon-redo',onClick:uc.form.Cancel">返回</a>
        </div>
    </form>
</body>
</html>
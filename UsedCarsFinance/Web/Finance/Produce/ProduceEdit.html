<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>产品维护</title>

    <link href="../../Content/easyui/themes/bootstrap/easyui.css" rel="stylesheet" />
    <link href="../../Content/easyui/themes/icon.css" rel="stylesheet" />
    <link href="../../Content/form-bootstrap.css" rel="stylesheet" />
    <script src="../../Scripts/jquery/jquery.js"></script>
    <script src="../../Scripts/easyui/jquery.easyui.js"></script>
    <script src="../../Scripts/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="../../Scripts/usedcars.js"></script>
    <script type="text/javascript">
        var query = uc.GetParams();

        uc.form = new UCForm(".container");

        $(function () {
            Init();
        });

        function Init() {
            if (query.method == "mod" || query.method == "view") {
                $("a#save").linkbutton("disable");

                $.ajax({
                    async: true,
                    type: "Get",
                    data: { produceId: query.ProduceId },
                    url: "../../api/NewProduce/Get",
                    success: function (data) {
                        LoadData(data);
                    }
                });

                $("a#save").linkbutton("enable");

                if (query.method == "mod") {
                    $("form.container fieldset#Base>legend").text("产品编辑");
                    $("#Code").textbox("readonly", true)
                }
                if (query.method == "view") {
                    $("form.container fieldset#Base>legend").text("产品详情");

                    $("#save").linkbutton("disable");

                    Disabled("fieldset")
                }
            }
            else {
                $("form.container fieldset#Base>legend").text("新产品录入");
            }

            // 禁用
            function Disabled(selector) {
                selector = selector || "fieldset";

                $(selector).attr("disabled", "disabled");

                $(selector).find(".easyui-combobox").combobox("disable");


                if ($(selector).hasClass(".easyui-combobox")) {
                    $(selector).combobox("disable");
                }
            }
        }

        function LoadData(data) {
            $("form.container fieldset#Base").form('load', data);

            var repayArray = data.RepayPrincipals.split('-');
            
            $("form.container fieldset#RepayPrincipals>div.row input[textboxname=RepayPrincipal]").each(function (i, e) {
                $(e).textbox('setValue', repayArray[i]);
            });
        }

        function BuildData() {
            var data = $("form.container fieldset#Base").serializeJson();
            data.RepayPrincipal = [];

            var repay = $("form.container fieldset#RepayPrincipals").serializeJson();

            if (Object.prototype.toString.call(repay.RepayPrincipal) === '[object Array]') {
                data.RepayPrincipal = repay.RepayPrincipal;
            }
            else {
                data.RepayPrincipal.push(repay.RepayPrincipal);
            }

            return data;
        }

        function ValidData() {
            var valid = $("form.container").form('validate');

            if (valid == false) {
                $.messager.show({ msg: "请填写完必填项！" });
            }

            var data = BuildData();
            data.cal = 0;

            $(data.RepayPrincipal).each(function (i, e) {
                data.cal += parseFloat(e);
            });

            valid = valid && (data.cal == 100);

            if (valid == false)
            {
                $.messager.show({ msg: "偿还本金比例之和应为100%！" });
            }

            return valid;
        }

        function Submit() {
            if (ValidData() == false)
            {
                return;
            }

            var url = "../../api/NewProduce/";

            if (query.method == "add") {
                url += "Create";
            }
            else if (query.method == "mod") {
                url += "Modify";
            }

            var data = BuildData();

            $.ajax({
                async: false,
                type: 'POST',
                data: data,
                url: url,
                statusCode: {
                    200: function (data) {
                        uc.form.Cancel();
                        top.$.messager.show({ msg: "提交成功" });
                    },
                    400: function (data) {
                        top.$.messager.show({ msg: data.responseJSON.Message });
                    }
                }
            });
        }



    </script>

    <script type="text/javascript">
        $.extend($.fn.validatebox.defaults.rules, {
            Money: {
                validator: function (value) {
                    if (/^-?\d+\.\d{1}$/.test(value)) {
                        return true;
                    }

                    if (/^-?\d+\.\d{2}$/.test(value) || /^-?\d+$/.test(value)) {
                        if (value.length >= 2 && /^[0][0-9]*$/.test(value.substr(0, 2))) {
                            return false;
                        }

                        return true;
                    }

                    return false;
                },
                message: '请输入整数、一位小数或两位小数！'
            },
            Rate: {
                validator: function (value) {
                    if (isNaN(value) == false) {
                        if (value >= 0 && value<=100)
                        return true;
                    }

                    return false;
                },
                message: '比例区间[0,100]'
            },
            AN: {
                validator: function (value) {
                    return !/[\u4E00-\u9FA5\uF900-\uFA2D]/.test(value);
                },
                message: '只能输入字母或数字或字母数字组合'
            },
            Integer: {// 验证整数
                validator: function (value) {
                    return /^\d+$/.test(value);
                },
                message: '请输入整数'
            }
        });
    </script>
</head>
<body>
    <form class="container">
        <fieldset id="Base">
            <legend>产品信息</legend>

            <div class="hidden">
                <input name="Id" type="hidden" />
            </div>

            <div class="row">
                <div class="col-6">
                    <label>产品类型:</label>
                    <input name="ProduceType" class="easyui-combobox" data-options="required:true,editable:false,
                           valueField: 'value',
		                   textField: 'text',
                           data:[
                           {value:'1',text:'纯分期'},
                           {value:'2',text:'保证金加三期月供提前付'},
                           {value:'3',text:'均匀贷'},
                           {value:'4',text:'低息贷'},
                           {value:'5',text:'保证金加分期'}
                           ]
                    " />
                </div>
                <div class="col-6">
                    <label>代码:</label>
                    <input name="Code" class="easyui-textbox" data-options="required:true,validType:['length[0,100]','AN']" />
                </div>
                <div class="col-6">
                    <label>期限:</label>
                    <input name="TimeLimit" class="easyui-textbox" data-options="required:true,validType:['Integer','length[0,6]'],onChange:ChangeTimeLimit" />
                    <unit>期</unit>
                </div>
                <div class="col-6">
                    <label>间隔:</label>
                    <input name="Interval" class="easyui-textbox" data-options="required:true,validType:['Integer','length[0,6]'],onChange:ChangeTimeLimit" />
                    <unit>月</unit>
                </div>
                <div class="col-6">
                    <label>手续费:</label>
                    <input name="Poundage" class="easyui-textbox" data-options="required:true,validType:['Money','length[0,20]']" />
                    <unit>元</unit>
                </div>
                <div class="col-6">
                    <label>保证金:</label>
                    <input name="MarginRate" class="easyui-textbox" data-options="required:true,validType:['Money','length[0,3]','Rate']" />
                    <unit>%</unit>
                </div>

                <div class="col-6">
                    <label>月费率:</label>
                    <input name="MonthRate" class="easyui-textbox" data-options="required:true,validType:['Money','length[0,3]','Rate']" />
                    <unit>%</unit>
                </div>
                <div class="col-6">
                    <label>渠道返点:</label>
                    <input name="ChannelRate" class="easyui-textbox" data-options="required:true,validType:['Money','length[0,3]','Rate']" />
                    <unit>%</unit>
                </div>
                <div class="col-6">
                    <label>员工提成:</label>
                    <input name="SalesmanRate" class="easyui-textbox" data-options="required:true,validType:['Money','length[0,3]','Rate']" />
                    <unit>%</unit>
                </div>
                <div class="col-6">
                    <label>名义利率:</label>
                    <input name="InterestRate" class="easyui-textbox" data-options="required:true,validType:['Money','length[0,3]','Rate']" />
                    <unit>%</unit>
                </div>
                <div class="col-6">
                    <label>租赁方式:</label>
                    <input name="LeaseType" class="easyui-combobox" data-options="required:true,editable:false,
                           valueField: 'value',
		                   textField: 'text',
                           data:[{value:'1',text:'回租'},{value:'2',text:'直租'}]
                    " />
                </div>
            </div>

            <script type="text/javascript">
                function ChangeTimeLimit() {
                    var value = $("form.container fieldset#Base input[textboxname=TimeLimit]").textbox('getValue');

                    var interval = $("form.container fieldset#Base input[textboxname=Interval]").textbox('getValue');

                    if (isNaN(value) == false && value != "" && isNaN(interval) == false && interval != "") {
                        $("form.container fieldset#RepayPrincipals>div.row>div.col-6").remove();
                        $("form.container fieldset#RepayPrincipals").show();

                        var fieldset = $("form.container fieldset#RepayPrincipals");
                        var html = $("form.container fieldset#RepayPrincipals template").html();
                        var texts = ['一', '二', '三', '四', '五'];

                        for (var i = 0; i < value / interval / 12; i++) {
                            if (i < 5)
                            {
                                fieldset.find("div.row").append(html);
                                fieldset.find("label:last").text('第' + texts[i] + '年:');
                            }
                        }

                        $.parser.parse(fieldset.find("div.row"));
                    }
                }
            </script>
        </fieldset>

        <fieldset id="RepayPrincipals" style="display:none">
            <legend>偿还本金比例</legend>
            <div class="row">
            </div>
            <template>
                <div class="col-6">
                    <label>第n年:</label>
                    <input name="RepayPrincipal" class="easyui-textbox" data-options="required:true,validType:['Money','length[0,3]','Rate']" />
                    <unit>%</unit>
                </div>
            </template>
        </fieldset>

        <div id="btn">
            <a id="save" class="easyui-linkbutton" href="javascript:void(0)" data-options="iconCls:'icon-save',onClick:Submit">保存</a>
            <a id="back" class="easyui-linkbutton" href="javascript:void(0)" data-options="iconCls:'icon-redo',onClick:uc.form.Cancel">返回</a>
        </div>
    </form>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>授信主体详情</title>
    <meta charset="utf-8" />
    <link href="../Content/easyui/themes/bootstrap/easyui.css" rel="stylesheet" />
    <link href="../Content/easyui/themes/icon.css" rel="stylesheet" />
    <link href="../Content/form-bootstrap.css" rel="stylesheet" />
    <script src="../Scripts/jquery/jquery.js"></script>
    <script src="../Scripts/easyui/jquery.easyui.js"></script>
    <script src="../Scripts/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="../Scripts/usedcars.js"></script>
    <script>
        uc.form = new UCForm("#credit_ff");

        $(function () {
            Init();
        });

        function Init() {
            var query = uc.GetParams();

            LoadAllProvince();
            LoadProcessUser();

            if (query.method == "mod" || query.method == "view") {
                if (query.method == "mod") {
                    $("input[comboname='Type']").textbox("disable");
                }
                if (query.method == "view") {
                    $("#save").linkbutton("disable");

                    uc.form.DisableForm();
                }

                uc.form.LoadForm({
                    params: { creditId: query.creditId },
                    url: "../api/Credit/Get",
                    onLoadSuccess: function (data) {
                        $(data.Produces).each(function () {
                            ProduceAdd(this.Code, this.ProduceId);
                        });
                        uc.form.Load(data.ProcessUser, "#process_user");
                    }
                });

                var record = { value: $("select[comboname=Province").combobox('getValue') };
                var CityCode = $("select[comboname=City").combobox('getValue');
                LoadCityByProvinceId(record);
                loadCityByCityCode(CityCode);
            }
        }

        function Submit() {
            var value = $.extend({},
                $("#credit_info").serializeJson(),
                $("#partner_info").serializeJson(),
                { ProcessUser: $("#process_user").serializeJson() }
                );

            value.Produces = [];
            $("select[name=Produces] option").each(function () {
                value.Produces.push({ ProduceId: this.value });
            });

            uc.form.Submit({
                url: "../api/Credit",
                method: "auto",
                data: value
            });
        }

        function ProduceAdd(text, value) {
            //判断是否存在重复项
            if (!$("select[name=Produces]").find("option[value=" + value + "]").length) {
                //创建选项并追加至列表框中
                $("<option>", { text: text, value: value }).appendTo("select[name=Produces]");
            }
        }
        function ProduceAppend() {
            var produce = $("select[comboname=Produce]");

            ProduceAdd(
				produce.combobox("getText"),
				produce.combobox("getValue")
			);
        }
        function ProduceRemove() {
            //移除已选中的项
            $("select[name=Produces] option:selected").remove();
        }

        function LoadAllProvince() {
            $.ajax({
                async: false,
                method: "GET",
                url: '../api/Credit/OptionProvince',
                statusCode: {
                    200: function (data) { $("select[comboname=Province").combobox("loadData", data); }
                }
            });
        }
        function LoadCityByProvinceId(record) {
            $("select[comboname=City").combobox('setValue', "");

            $.ajax({
                async: true,
                method: "GET",
                data: { ProvinceCode: record.value },
                url: '../api/Credit/OptionCitys',
                success: function (data) {
                    $("select[comboname=City").combobox("loadData", data);
                }
            });
        }

        function loadCityByCityCode(CityCode) {
            $.ajax({
                async: true,
                method: "GET",
                data: { CityCode: CityCode },
                url: '../api/Credit/OptionCity',
                success: function (data) {
                    $("select[comboname=City").combobox('setValue', data[0].value);
                    $("select[comboname=City").combobox('setText', data[0].text);
                }
            });
        }

    </script>
</head>
<body>
    <form id="credit_ff" class="container">
        <fieldset id="credit_info">
            <legend>授信信息</legend>

            <div class="hidden">
                <input type="text" name="CreditId" hidden />
            </div>

            <div class="row">
                <div class="col-6">
                    <label>主体名称:</label>
                    <input name="Name" class="easyui-textbox" required />
                </div>

                <div class="col-6">
                    <label>主体类型:</label>
                    <select name="Type" class="easyui-combobox" data-options="editable:false,readonly:true">
                        <option value="1">渠道授信</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-6">
                    <label>授信额度:</label>
                    <input name="LineOfCredit" class="easyui-textbox" required data-options="validType:'Price'" />
                    <span class="unit">元</span>
                </div>

                <div class="col-6 hidden">
                    <label>授信余额:</label>
                    <input name="CreditBalance" class="easyui-textbox" readonly />
                    <span class="unit">元</span>
                </div>
            </div>

            <div class="row">
                <div class="col-6">
                    <label>选择产品:</label>
                    <select name="Produce" class="easyui-combobox" data-options="
						method:'GET',
						url:'../api/Produce/Option',
						editable:false,
						width:315
					"></select>
                    <button type="button" onclick="ProduceAppend()">添加</button>
                    <button type="button" onclick="ProduceRemove()">移除</button>
                </div>

                <div class="col-6">
                    <label>已选产品:</label>
                    <select name="Produces" multiple="multiple" size="6" style="width:410px;"></select>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <label>备注:</label>
                    <input name="Remarks" class="easyui-textbox" data-options="multiline:true" />
                </div>
            </div>
        </fieldset>

        <fieldset id="partner_info">
            <legend>渠道信息</legend>

            <div class="row">
                <div class="col-6">
                    <label>代理区域:</label>
                    <input name="ProxyArea" class="easyui-textbox" />
                </div>

                <div class="col-6">
                    <label>备案车管所:</label>
                    <input name="VehicleManage" class="easyui-textbox" />
                </div>
            </div>

            <div class="row">
                <div class="col-6">
                    <label>实际控制人姓名:</label>
                    <input name="ControllerName" class="easyui-textbox" />
                </div>
                <div class="row">
                    <div class="col-6">
                        <label>认缴保证金额度:</label>
                        <input name="Bail" class="easyui-textbox" required data-options="validType:'Price'" />
                        <span class="unit">元</span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-6">
                    <label>实际控制人身份证号:</label>
                    <input name="ControllerIdentity" class="easyui-textbox" data-options="validType:'Identity'" />
                </div>

                <div class="col-6">
                    <label>实际控制人电话号码:</label>
                    <input name="ControllerTelephone" class="easyui-textbox" data-options="validType:'Mobile'" />
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <label>渠道公司地址:</label>

                    <select name="Province" class="easyui-combobox" data-options="
                                width:203,
						        onSelect:LoadCityByProvinceId,
                                required:true,
						        editable:false
					        "></select>
                    <select name="City" class="easyui-combobox" data-options="
                                width:203,
                                required:true,
						        editable:false
					        "></select>
                    <input name="Address" style="width:480px;" class="easyui-textbox" />
                </div>
            </div>
        </fieldset>

        <fieldset id="process_user">
            <legend>审核人员</legend>

            <div class="row">
                <div class="col-6">
                    <label>初审人员:</label>
                    <select name="User1" class="easyui-combobox" data-options="editable:false" required></select>
                </div>

                <div class="col-6">
                    <label>复审人员:</label>
                    <select name="User2" class="easyui-combobox" data-options="editable:false" required></select>
                </div>
            </div>

            <div class="row">
                <div class="col-6">
                    <label>运营初审人员:</label>
                    <select name="User3" class="easyui-combobox" data-options="editable:false" required></select>
                </div>

                <div class="col-6">
                    <label>运营复审人员:</label>
                    <select name="User4" class="easyui-combobox" data-options="editable:false" required></select>
                </div>
            </div>

            <div class="row">
                <div class="col-6">
                    <label>财务审核人员:</label>
                    <select name="User5" class="easyui-combobox" data-options="editable:false" required></select>
                </div>
            </div>

            <script>
                function LoadProcessUser() {
                    LoadCombobox("select[comboname='User1']", { RoleId: 3 });
                    LoadCombobox("select[comboname='User2']", { RoleId: 4 });
                    LoadCombobox("select[comboname='User3']", { RoleId: 5 });
                    LoadCombobox("select[comboname='User4']", { RoleId: 10 });
                    LoadCombobox("select[comboname='User5']", { RoleId: 6 });

                    function LoadCombobox(selector, params) {
                        $.ajax({
                            async: false,
                            method: "GET",
                            url: "../api/User/Option",
                            data: params,
                            statusCode: {
                                200: function (data) { $(selector).combobox("loadData", data); },
                                400: uc.E400
                            }
                        });
                    }
                }
            </script>
        </fieldset>

        <div id="btn">
            <a href="javascript:void(0)" id="save" class="easyui-linkbutton" data-options="iconCls:'icon-save',onClick:Submit">保存</a>
            <a href="javascript:void(0)" id="back" class="easyui-linkbutton" data-options="iconCls:'icon-redo',onClick:uc.form.Cancel">返回</a>
        </div>
    </form>
</body>
</html>
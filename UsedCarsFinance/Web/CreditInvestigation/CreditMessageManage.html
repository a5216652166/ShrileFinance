<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>征信报文管理</title>
    <link href="../Content/easyui/themes/bootstrap/easyui.css" rel="stylesheet" />
    <link href="../Content/easyui/themes/icon.css" rel="stylesheet" />
    <link href="../Content/form-bootstrap.css" rel="stylesheet" />
    <script src="../Scripts/jquery/jquery.js"></script>
    <script src="../Scripts/easyui/jquery.easyui.js"></script>
    <script src="../Scripts/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="../Scripts/usedcars.js"></script>
    <meta charset="utf-8" />
    <script>
        var editIndex = undefined;

        uc.grid = new UCGrid("#dg");

        function Reload() {
            uc.grid.Reload();
        }

        function BeforeLoad(param) {
            param.search = $("#Name").textbox("getValue");
            param.status = $("#Status").textbox("getValue");
        }

        // 键盘enter键
        document.onkeydown = function (event) {
            var e = event || window.event || arguments.callee.caller.arguments[0];
            if (e && e.keyCode == 13) { // enter 键
                // 只是在datagrid中回车时候回去datagrid的ID
                var id = $(e.target).parents(".panel.datagrid").find(".easyui-datagrid").attr("id")
                // 防止在其他文本框按enter建时候报错
                if (id != undefined) {
                    accept(id);
                }
                // 按回车保存修改结果
                Save();
            }
        };

        $.extend($.fn.datagrid.methods, {
            getEditingRowIndexs: function (jq) {
                var id = $(jq).attr("id");
                var rows = $.data(jq[0], "datagrid").panel.find('.datagrid-row-editing');
                var indexs = [];
                rows.each(function (i, rows) {
                    accept(id)
                });
            }
        });

        // 双击编辑行
        function onEditor(index, field, value) {
            $('#dg').datagrid('getEditingRowIndexs');
            if (editIndex != index) {
                var row = $('#' + this.id).datagrid("getSelected");
                //不可编辑状态
                if (row["IsEdit"] == false) {
                    $('#' + this.id).datagrid('selectRow', editIndex);
                }
                else {
                    if (endEditing(this.id)) {
                        $('#' + this.id).datagrid('selectRow', index)
                                .datagrid('beginEdit', index);
                        var ed = $('#' + this.id).datagrid('getEditor', { index: index, field: field });
                        if (ed != null) {
                            $(ed.target).focus();
                            editIndex = index;
                        }
                    } else {
                        $('#' + this.id).datagrid('selectRow', editIndex);
                    }
                }
            }
        }

        // 结束编辑状态
        function endEditing(id) {
            if (editIndex == undefined) { return true }

            if ($('#' + id).datagrid('validateRow', editIndex)) {
                var ed = $('#' + id).datagrid('getEditors', editIndex);
                var name = $(ed[0].target).val();
                $('#' + id).datagrid('getRows')[editIndex]['Name'] = name;
                $('#' + id).datagrid('endEdit', editIndex);
                editIndex = undefined;
                return true;
            } else {
                return false;
            }
        }

        // 结束编辑状态后保存数据在datagrid
        function accept(id) {
            if (endEditing(id)) {
                $('#' + id).datagrid('acceptChanges');
            }
        }

        // 保存修改后的名称
        function Save() {
            var row = $("#dg").datagrid("getSelected");

            if (row == undefined) {
                $.messager.show({ msg: "请选择需要修改的跟踪记录" });
            }
            else {
                accept("dg");

                $.ajax({
                    async: false,
                    method: "POST",
                    data: { Id: row.Id, Name: row.Name },
                    url: "../api/Datagram/ModifyName",
                    statusCode: {
                        200: function (data) {
                            $.messager.show({ msg: "修改成功" });
                        },
                        400: function (data) {
                            $.messager.show({ msg: data.responseJSON.Message });
                        }
                    }
                });

                $("#mod").linkbutton("enable");
            }
        }

        // 生成
        function Generate() {
            // 所有勾选的行
            var array = $("#dg").datagrid("getChecked");
            if (array == undefined) {
                $.messager.show({ msg: "请选择需要生成的跟踪记录" });
            }
            else {
                // 用于记录已生成的报文追踪
                var count = 0;
                for (var i = 0; i < array.length; i++) {
                    if (array[i].StatusDesc == "待发送") {
                        count++;
                    }
                }

                if (count > 0) {
                    // 提示框
                    $.messager.confirm("操作提示", "存在" + count + "条已生成报文，是否重新生成？", function (data) {
                        if (data) {
                        }
                        else {
                            // 筛选状态为待生成的报文
                            array = $.grep(array, function (e, i) {
                                return e.StatusDesc == "待生成";
                            });
                        }
                        submit(array);
                    });
                }
                else {
                    submit(array);
                }
            }
        }

        // 提交需要生成报文的追踪ID
        function submit(array) {
            if (array == undefined || array.length == 0) {
                $.messager.show({ msg: "请勾选待生成报文" });
            }
            else {
                // 所有勾选的报文跟踪ID
                var data = [];
                $(array).each(function () {
                    data.push(this.Id);
                });

                $.ajax({
                    async: false,
                    method: "POST",
                    data: { Ids: data },
                    url: "../api/Datagram/Generate",
                    statusCode: {
                        200: function (data) {
                            $.messager.show({ msg: "生成成功" });
                        },
                        400: function (data) {
                            $.messager.show({ msg: data.responseJSON.Message });
                        }
                    }
                });

                $("#add").linkbutton("enable");
                Reload();
            }
        }

        // 下载
        function Download() {
            $("#download input").remove();
            var array = $("#dg").datagrid("getChecked");
            if (array == undefined) {
                $.messager.show({ msg: "请选择需要下载的跟踪记录" });
            }
            else {
                // 所有勾选的报文跟踪ID
                var data = [];
                $(array).each(function () {
                    data.push(this.Id);
                    $("<input>", { name: "Ids", value: this.Id }).appendTo("#download");
                });

                $("#download").submit();

                $("#save").linkbutton("enable");
                Reload();
            }
        }

    </script>
</head>
<body>
    <table id="dg" class="easyui-datagrid" data-options="height:630,toolbar:'#tb',rownumbers:true,
        onDblClickCell:onEditor,
        pagination: true,
        pageSize: 20,
        pageList: [10,20,30,40,50],
        method: 'GET',
        url: '../api/Datagram/GetPageList',
        loadMsg: '正在加载，请稍候...',
        onBeforeLoad: BeforeLoad
        ">
        <thead>
            <tr>
                <th data-options="field:'ck',checkbox:true"></th>
                <th data-options="field:'Id',hidden:true">Id</th>
                <th data-options="field:'Name',width:450,align:'left',editor:{type:'validatebox'}">名称</th>
                <th data-options="field:'TypeDesc',width:180,align:'left'">操作类型</th>
                <th data-options="field:'StatusDesc',width:180,align:'left'">报文状态</th>
                <th data-options="field:'DateCreated',width:180,align:'left'">跟踪日期</th>
                <th data-options="field:'SpecialDate',width:180,align:'left'">业务发生日期</th>
                <th data-options="field:'IsEdit',width:180,align:'left',hidden:true">是否可编辑</th>
            </tr>
        </thead>
    </table>
    <div id="tb">
        <div style="height:30px;width:auto;">
            <input id="Name" name="Name" class="easyui-textbox" style="width: 200px;height:25px; margin-top:3px;" data-options="prompt:'请输入名称'" />
            <span>报文状态:</span>
            <select id="Status" class="easyui-combobox" style="width:100px;height:25px; margin-top:3px;">
                <option value="">全部</option>
                <option value="0">待生成</option>
                <option value="1">待发送</option>
                <option value="2">已发送</option>
                <option value="3">待反馈</option>
                <option value="4">待反馈</option>
            </select>
            <a id="search" class="easyui-linkbutton" href="javascript:void(0)" style="width: auto;height:25px; margin-top:3px;" data-options="iconCls:'icon-search',onClick:Reload">搜索</a>
            <a id="mod" class="easyui-linkbutton" href="javascript:void(0)" style="width: auto;height:25px; margin-top:3px;" data-options="iconCls:'icon-save',plain:true,onClick:Save">保存</a>
            <a id="add" class="easyui-linkbutton" href="javascript:void(0)" style="width: auto;height:25px; margin-top:3px;" data-options="iconCls:'icon-add',plain:true,onClick:Generate">生成</a>
            <a id="save" class="easyui-linkbutton" href="javascript:void(0)" style="width: auto;height:25px; margin-top:3px;" data-options="iconCls:'icon-add',plain:true,onClick:Download">下载</a>
        </div>
    </div>

    <div>
        <form id="download" action="../api/Datagram/Download" method="post" style="display:none">
        </form>
    </div>
</body>
</html>
